<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News ê´€ë¦¬ - Admin</title>
    <link rel="stylesheet" href="admin_style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header"><h2>ADMIN</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index_admin.html">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a></li>
                    <li><a href="admin_about.html">â„¹ï¸ About ê´€ë¦¬</a></li>
                    <li><a href="admin_service.html">ğŸ›  Service ê´€ë¦¬</a></li>
                    <li><a href="admin_news.html">ğŸ“° News ê´€ë¦¬</a></li>
                    <li><a href="admin_contact.html">ğŸ“ Contact ê´€ë¦¬</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><a href="../index.html" class="btn-exit">ğŸ  ì‚¬ì´íŠ¸ ë‚˜ê°€ê¸°</a></div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h1>News ê´€ë¦¬</h1>
                <div class="user-info">ì†Œì‹ì„ ê´€ë¦¬í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ì„œë²„ì— ì €ì¥í•˜ì„¸ìš”.</div>
            </header>

            <section class="admin-card-section">
                <div class="section-title">ğŸ“° ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸</div>
                <div class="table-container">
                    <table class="partner-table">
                        <thead>
                            <tr>
                                <th>ì´ë¯¸ì§€</th>
                                <th>ì œëª© / ì†Œì œëª©</th>
                                <th>ì‘ì„±ì / ë‚ ì§œ</th>
                                <th>ì—°ê²° ë§í¬</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="newsTableBody">
                            </tbody>
                    </table>
                </div>
                <div class="table-actions" style="justify-content: flex-end; margin-top: 15px;">
                    <button class="btn-save-all" style="background-color: #4299e1;" onclick="showForm('add')">+ ìƒˆ ë‰´ìŠ¤ ì‘ì„±</button>
                </div>
            </section>

            <section id="newsFormSection" class="admin-card-section" style="display: none; border-top: 4px solid #4299e1;">
                <div class="section-title" id="formTitle">â• ìƒˆ ë‰´ìŠ¤ ì‘ì„±</div>
                <form id="newsForm" class="large-form">
                    <input type="hidden" id="editId"> <div class="input-group">
                        <label>ë‰´ìŠ¤ ì œëª©</label>
                        <input type="text" id="newsTitle" class="input-lg" placeholder="ë‰´ìŠ¤ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    
                    <div class="input-group">
                        <label>ì†Œì œëª© (ë‚´ìš© ìš”ì•½)</label>
                        <textarea id="newsSubTitle" class="input-lg" rows="3" placeholder="ë‰´ìŠ¤ì— ëŒ€í•œ ì§§ì€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>

                    <div class="input-row-3">
                        <div class="input-group">
                            <label>ì‘ì„±ì</label>
                            <input type="text" id="newsAuthor" class="input-lg" value="ê´€ë¦¬ì">
                        </div>
                        <div class="input-group">
                            <label>ì‘ì„±ì¼</label>
                            <input type="date" id="newsDate" class="input-lg">
                        </div>
                        <div class="input-group">
                            <label>ì—°ë™ ë§í¬ (URL)</label>
                            <input type="url" id="newsLink" class="input-lg" placeholder="https://...">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>ëŒ€í‘œ ì´ë¯¸ì§€</label>
                        <div class="upload-box-lg" onclick="document.getElementById('newsFile').click()">
                            <input type="file" id="newsFile" accept="image/*" hidden onchange="previewNewsImage(this)">
                            <div id="newsPreview">
                                <span>ì´ê³³ì„ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions-lg">
                        <button type="button" class="btn-cancel-lg" onclick="hideForm()">ì°½ ë‹«ê¸°</button>
                        <button type="submit" class="btn-save-lg">ì„œë²„ì— ì €ì¥í•˜ê¸°</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <script>
        // 2. Supabase ì„¤ì • (ë³¸ì¸ì˜ ì •ë³´ë¡œ êµì²´í•˜ì„¸ìš”)
        const SUPABASE_URL = 'https://vhmihojfcokhkoxpejuj.supabase.com'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZobWlob2pmY29raGtveHBlanVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0Njg1OTMsImV4cCI6MjA4NDA0NDU5M30.k5O_GS11jn-FJ4XU1aR2PgpSplBAe984WsSxEp4oshg'; // ì°¾ìœ¼ì‹  anon keyë¥¼ ì—¬ê¸°ì— ì…ë ¥
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const formSection = document.getElementById('newsFormSection');
        const formTitle = document.getElementById('formTitle');
        let currentImgData = ""; // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì €ì¥ìš©

        // 3. í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', loadNews);

        async function loadNews() {
            const { data: newsList, error } = await _supabase
                .from('news_table')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
                return;
            }

            const tbody = document.getElementById('newsTableBody');
            tbody.innerHTML = '';

            newsList.forEach((news) => {
                tbody.innerHTML += `
                    <tr>
                        <td><div class="table-img-box"><img src="${news.img_url || 'https://via.placeholder.com/100x60'}"></div></td>
                        <td><strong>${news.title}</strong><br><small class="text-muted">${news.sub_title}</small></td>
                        <td>${news.author}<br><small>${news.date}</small></td>
                        <td><a href="${news.link_url}" target="_blank" class="link-text">ë°©ë¬¸í•˜ê¸° ğŸ”—</a></td>
                        <td>
                            <button class="btn-table-delete" onclick="deleteNews('${news.id}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });
        }

        // 4. ì €ì¥ ê¸°ëŠ¥ (ì¶”ê°€/ìˆ˜ì • í†µí•©)
        document.getElementById('newsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newsData = {
                title: document.getElementById('newsTitle').value,
                sub_title: document.getElementById('newsSubTitle').value,
                author: document.getElementById('newsAuthor').value,
                date: document.getElementById('newsDate').value,
                link_url: document.getElementById('newsLink').value,
                img_url: currentImgData || 'https://via.placeholder.com/400x200'
            };

            const { data, error } = await _supabase
                .from('news_table')
                .insert([newsData]);

            if (error) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            } else {
                alert('ì„œë²„ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                hideForm();
                loadNews();
            }
        });

        // 5. ì‚­ì œ ê¸°ëŠ¥
        async function deleteNews(id) {
            if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë°ì´í„°ê°€ ì„œë²„ì—ì„œ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.')) return;
            
            const { error } = await _supabase
                .from('news_table')
                .delete()
                .eq('id', id);

            if (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            } else {
                loadNews();
            }
        }

        // --- UI ì œì–´ í•¨ìˆ˜ë“¤ ---
        function showForm(mode) {
            formSection.style.display = 'block';
            document.getElementById('newsForm').reset();
            currentImgData = "";
            document.getElementById('newsPreview').innerHTML = "<span>ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>";
            formSection.scrollIntoView({ behavior: 'smooth' });
        }

        function hideForm() {
            formSection.style.display = 'none';
        }

        function previewNewsImage(input) {
            const preview = document.getElementById('newsPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImgData = e.target.result;
                    preview.innerHTML = `<img src="${currentImgData}" style="max-height: 200px; width: auto; border-radius: 8px;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>
</html>